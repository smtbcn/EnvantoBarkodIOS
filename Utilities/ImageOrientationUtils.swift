import UIKit
import ImageIO
import CoreGraphics
import Foundation

class ImageOrientationUtils {
    
    private static let TAG = "ImageOrientationUtils"
    
    /// EXIF orientation bilgisini okuyup resimleri otomatik d√∂nd√ºren ana metod
    static func fixImageOrientation(imagePath: String) -> String {
        print("üîÑ [\(TAG)] Resim orientation i≈üleniyor: \(imagePath)")
        
        guard let imageSource = CGImageSourceCreateWithURL(URL(fileURLWithPath: imagePath) as CFURL, nil) else {
            print("‚ùå [\(TAG)] Image source olu≈üturulamadƒ±")
            return imagePath
        }
        
        // EXIF orientation bilgisini oku
        guard let properties = CGImageSourceCopyPropertiesAtIndex(imageSource, 0, nil) as? [String: Any] else {
            print("‚ùå [\(TAG)] Image properties okunamadƒ±")
            return imagePath
        }
        
        let orientation = getImageOrientation(from: properties)
        print("üìê [\(TAG)] EXIF Orientation: \(getOrientationName(orientation))")
        
        // Orientation d√ºzeltmesi gerekli mi?
        if orientation == .up {
            print("‚ÑπÔ∏è [\(TAG)] Orientation zaten doƒüru, i≈ülem gerekmiyor")
            return imagePath
        }
        
        // Resmi y√ºkle ve d√∂nd√ºr
        guard let image = UIImage(contentsOfFile: imagePath) else {
            print("‚ùå [\(TAG)] Resim y√ºklenemedi")
            return imagePath
        }
        
        let rotationAngle = getRotationAngle(from: orientation)
        print("üîÑ [\(TAG)] Rotation a√ßƒ±sƒ±: \(rotationAngle)¬∞")
        
        print("üîÑ [\(TAG)] rotateImage metodu √ßaƒürƒ±lƒ±yor...")
        let rotatedImage = rotateImage(image, angle: rotationAngle)
        print("üîÑ [\(TAG)] rotateImage metodu tamamlandƒ±")
        
        // D√∂nd√ºr√ºlm√º≈ü resmi kaydet
        guard let imageData = rotatedImage.jpegData(compressionQuality: 0.9) else {
            print("‚ùå [\(TAG)] Rotated image data olu≈üturulamadƒ±")
            return imagePath
        }
        
        do {
            try imageData.write(to: URL(fileURLWithPath: imagePath))
            print("‚úÖ [\(TAG)] Orientation d√ºzeltmesi ba≈üarƒ±yla uygulandƒ±")
            return imagePath
        } catch {
            print("‚ùå [\(TAG)] Rotated image kaydetme hatasƒ±: \(error)")
            return imagePath
        }
    }
    
    /// URI'den resmi y√ºkler, orientation d√ºzeltir ve belirtilen yola kaydeder
    static func copyAndFixOrientation(sourceURL: URL, destinationPath: String) -> Bool {
        print("üìã [\(TAG)] Copy ve fix orientation: \(sourceURL.path) -> \(destinationPath)")
        
        do {
            // √ñnce dosyayƒ± kopyala
            let data = try Data(contentsOf: sourceURL)
            try data.write(to: URL(fileURLWithPath: destinationPath))
            
            // Sonra orientation d√ºzeltmesi uygula
            let _ = fixImageOrientation(imagePath: destinationPath)
            
            return true
        } catch {
            print("‚ùå [\(TAG)] Copy ve fix orientation hatasƒ±: \(error)")
            return false
        }
    }
    
    /// Android mantƒ±ƒüƒ± ile device orientation + EXIF kombinasyonu
    /// Hem barkod resimleri hem m√º≈üteri resimleri i√ßin kullanƒ±lƒ±r
    static func fixImageOrientationWithDeviceOrientation(imagePath: String, deviceOrientation: UIDeviceOrientation) -> String {
        print("üîÑ [\(TAG)] Android mantƒ±ƒüƒ± ile orientation d√ºzeltmesi ba≈ülƒ±yor")
        print("üì± [\(TAG)] Device orientation: \(getDeviceOrientationName(deviceOrientation))")
        
        // 1. EXIF orientation d√ºzeltmesi
        let exifFixedPath = fixImageOrientation(imagePath: imagePath)
        
        // 2. Android mantƒ±ƒüƒ± ile manuel rotation
        guard let image = UIImage(contentsOfFile: exifFixedPath) else {
            print("‚ùå [\(TAG)] Resim y√ºklenemedi: \(exifFixedPath)")
            return exifFixedPath
        }
        
        let imageSize = image.size
        print("üìê [\(TAG)] EXIF sonrasƒ± resim boyutlarƒ±: \(imageSize.width)x\(imageSize.height)")
        
        // Android mantƒ±ƒüƒ±: Device orientation'a g√∂re target format belirle
        let targetShouldBePortrait = shouldTargetBePortrait(deviceOrientation: deviceOrientation)
        let currentIsPortrait = imageSize.height > imageSize.width
        
        print("üéØ [\(TAG)] Target format: \(targetShouldBePortrait ? "PORTRAIT" : "LANDSCAPE")")
        print("üìê [\(TAG)] Current format: \(currentIsPortrait ? "PORTRAIT" : "LANDSCAPE")")
        
        var rotationAngle: CGFloat = 0
        
        if targetShouldBePortrait && !currentIsPortrait {
            // Target portrait ama current landscape ‚Üí 90¬∞ d√∂nd√ºr
            rotationAngle = 90
            print("üîÑ [\(TAG)] Landscape ‚Üí Portrait: 90¬∞ rotation")
        } else if !targetShouldBePortrait && currentIsPortrait {
            // Target landscape ama current portrait ‚Üí 270¬∞ d√∂nd√ºr  
            rotationAngle = 270
            print("üîÑ [\(TAG)] Portrait ‚Üí Landscape: 270¬∞ rotation")
        } else {
            print("‚ÑπÔ∏è [\(TAG)] Format zaten doƒüru, rotation gerekmiyor")
            return exifFixedPath
        }
        
        // Rotation uygula
        let rotatedImage = rotateImage(image, angle: rotationAngle)
        
        // D√∂nd√ºr√ºlm√º≈ü resmi kaydet
        guard let imageData = rotatedImage.jpegData(compressionQuality: 0.9) else {
            print("‚ùå [\(TAG)] Rotated image data olu≈üturulamadƒ±")
            return exifFixedPath
        }
        
        do {
            try imageData.write(to: URL(fileURLWithPath: exifFixedPath))
            print("‚úÖ [\(TAG)] Android mantƒ±ƒüƒ± ile orientation d√ºzeltmesi ba≈üarƒ±yla uygulandƒ±")
            return exifFixedPath
        } catch {
            print("‚ùå [\(TAG)] Rotated image kaydetme hatasƒ±: \(error)")
            return exifFixedPath
        }
    }
    
    /// Device orientation'a g√∂re target format belirle (Android mantƒ±ƒüƒ±)
    private static func shouldTargetBePortrait(deviceOrientation: UIDeviceOrientation) -> Bool {
        switch deviceOrientation {
        case .portrait, .portraitUpsideDown:
            return true  // Portrait orientations ‚Üí Portrait resim
        case .landscapeLeft, .landscapeRight:
            return false // Landscape orientations ‚Üí Landscape resim
        default:
            return true  // Unknown ‚Üí Default portrait
        }
    }
    
    /// Device orientation adƒ±nƒ± d√∂nd√ºr (debug i√ßin)
    private static func getDeviceOrientationName(_ orientation: UIDeviceOrientation) -> String {
        switch orientation {
        case .portrait: return "PORTRAIT (0¬∞)"
        case .landscapeLeft: return "LANDSCAPE_LEFT (90¬∞)"
        case .portraitUpsideDown: return "PORTRAIT_UPSIDE_DOWN (180¬∞)"
        case .landscapeRight: return "LANDSCAPE_RIGHT (270¬∞)"
        default: return "UNKNOWN"
        }
    }

    /// UIImage'i belirtilen a√ßƒ±da d√∂nd√ºr√ºr
    static func rotateImage(_ image: UIImage, angle: CGFloat) -> UIImage {
        print("üîÑ [\(TAG)] rotateImage √ßaƒürƒ±ldƒ±: \(angle)¬∞ (radians: \(angle * .pi / 180.0))")
        print("üìê [\(TAG)] Orijinal boyut: \(image.size.width)x\(image.size.height)")
        
        let radians = angle * .pi / 180.0
        
        // Yeni boyutlarƒ± hesapla
        let rotatedSize = CGRect(origin: .zero, size: image.size)
            .applying(CGAffineTransform(rotationAngle: radians))
            .integral.size
            
        print("üìê [\(TAG)] D√∂nd√ºr√ºlm√º≈ü boyut: \(rotatedSize.width)x\(rotatedSize.height)")
        
        // Graphics context olu≈ütur
        UIGraphicsBeginImageContextWithOptions(rotatedSize, false, image.scale)
        defer { UIGraphicsEndImageContext() }
        
        guard let context = UIGraphicsGetCurrentContext() else {
            return image
        }
        
        // Koordinat sistemini merkeze ta≈üƒ±
        context.translateBy(x: rotatedSize.width / 2, y: rotatedSize.height / 2)
        
        // D√∂nd√ºrme uygula
        context.rotate(by: radians)
        
        // Resmi √ßiz
        image.draw(in: CGRect(
            x: -image.size.width / 2,
            y: -image.size.height / 2,
            width: image.size.width,
            height: image.size.height
        ))
        
        let rotatedImage = UIGraphicsGetImageFromCurrentImageContext() ?? image
        print("‚úÖ [\(TAG)] Rotation tamamlandƒ±, final boyut: \(rotatedImage.size.width)x\(rotatedImage.size.height)")
        return rotatedImage
    }
    
    /// EXIF orientation deƒüerinden d√∂nd√ºrme a√ßƒ±sƒ±nƒ± hesaplar
    /// iOS CGImagePropertyOrientation mantƒ±ƒüƒ± ile d√ºzeltilmi≈ü
    private static func getRotationAngle(from orientation: CGImagePropertyOrientation) -> CGFloat {
        switch orientation {
        case .up: return 0           // Normal orientation
        case .right: return 270      // Saat y√∂n√ºnde 90¬∞ d√∂nd√ºr√ºlm√º≈ü ‚Üí 270¬∞ ters d√∂nd√ºr
        case .down: return 0         // 180¬∞ d√∂nd√ºr√ºlm√º≈ü ama doƒüru y√∂nde ‚Üí rotation yok
        case .left: return 270       // Portrait Upside Down i√ßin ‚Üí 270¬∞ d√∂nd√ºr (90¬∞ yerine)
        case .upMirrored: return 0   // Mirror durumlarƒ±
        case .rightMirrored: return 270
        case .downMirrored: return 0  // Mirror + 180¬∞ ama doƒüru y√∂nde
        case .leftMirrored: return 270
        @unknown default: return 0
        }
    }
    
    /// Properties'den orientation bilgisini √ßƒ±karƒ±r
    private static func getImageOrientation(from properties: [String: Any]) -> CGImagePropertyOrientation {
        if let orientationValue = properties[kCGImagePropertyOrientation as String] as? UInt32 {
            return CGImagePropertyOrientation(rawValue: orientationValue) ?? .up
        }
        return .up
    }
    
    /// Debug i√ßin orientation adƒ±nƒ± d√∂nd√ºr√ºr
    private static func getOrientationName(_ orientation: CGImagePropertyOrientation) -> String {
        switch orientation {
        case .up: return "UP (0¬∞)"
        case .right: return "RIGHT (90¬∞)"
        case .down: return "DOWN (180¬∞)"
        case .left: return "LEFT (270¬∞)"
        case .upMirrored: return "UP_MIRRORED (0¬∞ + Mirror)"
        case .rightMirrored: return "RIGHT_MIRRORED (90¬∞ + Mirror)"
        case .downMirrored: return "DOWN_MIRRORED (180¬∞ + Mirror)"
        case .leftMirrored: return "LEFT_MIRRORED (270¬∞ + Mirror)"
        @unknown default: return "UNKNOWN"
        }
    }
}