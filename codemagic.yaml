workflows:
  final-clean-build:
    name: Final Clean iOS Build
    environment:
      groups:
        - admin
      xcode: latest
      cocoapods: default
    scripts:
      - name: Check environment
        script: |
          echo "Starting clean build process..."
          xcode-select --print-path
          xcodebuild -version
      - name: Initialize keychain
        script: keychain initialize
      - name: List available resources
        script: |
          echo "=== Certificates ==="
          app-store-connect certificates list --type IOS_DISTRIBUTION
          echo "=== Profiles ==="
          app-store-connect profiles list --type IOS_APP_STORE
      - name: Download signing files with P12
        script: |
          # P12 sertifikası ile signing files'ları indir
          app-store-connect fetch-signing-files "com.envanto.barcode.ios" \
            --type IOS_APP_STORE
      - name: Add certificates to keychain
        script: keychain add-certificates
      - name: Configure code signing
        script: xcode-project use-profiles
      - name: Build IPA
        script: |
          xcode-project build-ipa \
            --project "EnvantoBarkod.xcodeproj" \
            --scheme "EnvantoBarkod" \
            --export-options-plist export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM