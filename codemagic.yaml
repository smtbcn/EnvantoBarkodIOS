workflows:
  ios-development-final:
    name: Envanto Barkod iOS Development Build (Final)
    max_build_duration: 90
    instance_type: mac_mini_m1
    environment:
      ios_signing:
        distribution_type: development
        bundle_identifier: com.envanto.barcode.ios
      vars:
        XCODE_WORKSPACE: "EnvantoBarkod.xcodeproj"
        XCODE_SCHEME: "EnvantoBarkod"
        BUNDLE_ID: "com.envanto.barcode.ios"
      xcode: latest
      cocoapods: default
    scripts:
      - name: Get CocoaPods dependencies
        script: |
          if [ -f "Podfile" ]; then
            pod install
          else
            echo "Podfile bulunamadƒ±, CocoaPods adƒ±mƒ± atlanƒ±yor"
          fi
      - name: Set up development code signing
        script: |
          echo "üîê Using existing development profile..."
          xcode-project use-profiles
      - name: Increment build number
        script: |
          BUILD_NUMBER=$(date +%Y%m%d%H%M)
          echo "üî¢ Setting build number to: $BUILD_NUMBER"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" Info.plist || true
      - name: Build development IPA
        script: |
          echo "üèóÔ∏è Building development IPA..."
          xcode-project build-ipa \
            --workspace "$XCODE_WORKSPACE" \
            --scheme "$XCODE_SCHEME" \
            --config "Debug"
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
    publishing:
      email:
        recipients:
          - samet.bicen@icloud.com
        notify:
          success: true
          failure: true

  ios-no-signing-build:
    name: Envanto Barkod iOS (No Signing - Backup)
    max_build_duration: 45
    instance_type: mac_mini_m1
    environment:
      vars:
        XCODE_WORKSPACE: "EnvantoBarkod.xcodeproj"
        XCODE_SCHEME: "EnvantoBarkod"
      xcode: latest
      cocoapods: default
    scripts:
      - name: Get CocoaPods dependencies
        script: |
          if [ -f "Podfile" ]; then
            pod install
          else
            echo "Podfile bulunamadƒ±, CocoaPods adƒ±mƒ± atlanƒ±yor"
          fi
      - name: Build without signing
        script: |
          xcodebuild \
            -project "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -sdk iphoneos \
            -configuration Debug \
            build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      - name: Create unsigned IPA
        script: |
          echo "üì¶ Creating unsigned IPA..."
          BUILD_DIR=$(find ~/Library/Developer/Xcode/DerivedData -name "*.app" -path "*/Build/Products/Debug-iphoneos/*" | head -1)
          if [ -n "$BUILD_DIR" ]; then
            mkdir -p build/Payload
            cp -r "$BUILD_DIR" build/Payload/
            cd build
            zip -r EnvantoBarkod-unsigned.ipa Payload/
            cd ..
            echo "‚úÖ Unsigned IPA created"
          fi
    artifacts:
      - build/*.ipa
      - /tmp/xcodebuild_logs/*.log
    publishing:
      email:
        recipients:
          - samet.bicen@icloud.com
        notify:
          success: true
          failure: true